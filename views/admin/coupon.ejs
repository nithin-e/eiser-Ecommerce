<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Management</title>
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- DataTables CSS CDN -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        .modal {
            cursor: pointer;
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0px;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            /* margin-top: 20px; */
        }
    
        .modal-content {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border: none;
            width: 90%;
            max-width: 450px;
            margin-top: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            margin-left: 450px;
            max-height: 80vh; 
            overflow-y: auto; 
        }
    
        .form-group {
            margin-bottom: 20px;
        }
    
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #3498db;
        }
    
        input[type="text"],
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 9px;
            box-sizing: border-box;
            border: 2px solid #34495e;
            border-radius: 8px;
            /* background-color: #34495e; */
            color: #ecf0f1;
            transition: border-color 0.3s ease;
        }
    
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus {
            border-color: #3498db;
            outline: none;
        }
    
        button {
            background-color: #e74c3c;
            color: white;
            padding: 12px 20px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
    
        button:hover {
            background-color: #c0392b;
        }
    </style>
   
</head>
<body>

    <%- include('../admin/adminpartials/Header') %>
    
    <div class="content">
        <%- include('../admin/adminpartials/adminNav') %>
        <%- include('../admin/adminpartials/adminSidebar') %>

        <div class="container-fluid">
            <div class="container mt-5">
                <h1 class="mb-4">Coupon Management</h1>

                <div class="top-bar d-flex justify-content-between mb-3">
                    <div id="toolbar">
                        <button id="add-category" class="btn btn-primary" onclick="showModal()">Add Coupon</button>
                    </div>
                </div>
               
                <div style="display: flex; align-items: center;">
                    <h4 id="errorMessage" style="display: none; color: green;"></h4>
                </div>
                
                <table id="userTable" class="table table-striped table-bordered text-center">
                    <thead class="thead-dark">
                        <tr>
                            
                            <th scope="col">Coupon Code</th>
                            <th scope="col">Minimum Purchase Amount</th>
                            <th scope="col">DiscountAmount</th>
                            <th scope="col">Date</th>
                            <th scope="col">Expiry Date</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% StoreCoupon.forEach(element => { %>                   
                        <tr>
                            <td><%=element.couponCode%></td>
                            <td><%=element.minPurchaseAmount%></td>
                            <td><%=element.discountAmount%></td>
                            <td><%= new Date(element.date).toLocaleDateString('en-US') %></td>
                             <td><%= new Date(element.expiryDate).toLocaleDateString('en-US') %></td>
                            <td class="text-center">
                                <a href="#" style="text-decoration: none;">
                                    <button style=" border-radius: 30px; border: none; width: 45px; height: 45px; color: white;">
                                        <i class="fas fa-trash-alt" style=" margin-left: -4px;"   onclick="Delete('<%=element._id%>')" ></i>
                                    </button>
                                </a>
                                <a style="text-decoration: none;">
                                    <button style="background-color: #2c3e50; border-radius: 30px; border: none; width: 45px; height: 45px; color: white;"
                                    type="button"
                                    data-code="<%=element.couponCode%>"
                                    data-id="<%=element._id%>"
                                    data-minpurchaseamount="<%=element.minPurchaseAmount%>"
                                    data-discountamount="<%=element.discountAmount%>"
                                    data-date="<%= new Date(element.date).toISOString().substring(0, 10) %>"
                                    data-expirydate="<%= new Date(element.expiryDate).toISOString().substring(0, 10) %>"
                                    onclick="OpenModal(this)">
                                <i class="fas fa-edit" style="margin-left: -4px;"></i>
                            </button>
                                </a>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="couponModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Create New Coupon</h2>
                <form id="couponForm" >
                    <div class="form-group">
                        <label for="couponCode">Coupon Code:</label>
                        <input type="text" id="couponCode" name="couponCode"   style="color: black;" required>
                    </div>
                    <div class="form-group">
                        <label for="minPurchaseAmount">Minimum Purchase Amount:</label>
                        <input type="number" id="minPurchaseAmount" name="minPurchaseAmount" step="0.01"  style="color: black;" required>
                    </div>
                    <div class="form-group">
                        <label for="discountAmount">Discount Amount:</label>
                        <input type="number" id="discountAmount" name="discountAmount" step="0.01"  style="color: black;" required>
                    </div>
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="date" name="date"  style="color: black;" required>
                    </div>
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date:</label>
                        <input type="date" id="expiryDate" name="expiryDate" style="color: black;" required>
                    </div>
                    <p id="errorMessagee" style="color: red; display: none;"></p>
                    <button type="submit" onclick="CreateCoupon()">Create Coupon</button>
                </form>
            </div>
        </div>
    </div>



    <!-- editmodal -->
    <div id="editCouponModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="StopModal()">&times;</span>
                <h2>Create New Coupon</h2>
                <form id="couponForm" >
                    <div class="form-group">
                        <label for="couponCode">Coupon Code:</label>
                        <input type="text" id="couponCodee" name="couponCode"   style="color: black;" required>
                    </div>
                   
                        <input type="text" id="edit-id" name="couponCode" hidden   style="color: black;" >                   
                   
                    <div class="form-group">
                        <label for="minPurchaseAmount">Minimum Purchase Amount:</label>
                        <input type="number" id="minPurchaseAmountt" name="minPurchaseAmount" step="0.01"  style="color: black;" required>
                    </div>
                    <div class="form-group">
                        <label for="discountAmount">Discount Amount:</label>
                        <input type="number" id="discountAmountt" name="discountAmount" step="0.01"  style="color: black;" required>
                    </div>
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="datee" name="date"  style="color: black;" required>
                    </div>
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date:</label>
                        <input type="date" id="expiryDatee" name="expiryDate" style="color: black;" required>
                    </div>
              <p id="errorMes" style="color: red; display: none;"></p>
                    <button type="submit" onclick="StoreCoupon()">Create Coupon</button>
                </form>
            </div>
        </div>
   <!-- end edit modal -->


        
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
        <!-- Bootstrap JS, Popper.js, and jQuery CDN -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <!-- DataTables JS CDN -->
        <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
        <script src="/js/userajax.js"></script>

        <script>
          $(document).ready(function() {
    $('#userTable').DataTable();
});

function showModal() {
    document.getElementById('couponModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('couponModal').style.display = 'none';
}

// Close the modal when clicking outside of it
window.onclick = function(event) {
    if (event.target == document.getElementById('couponModal')) {
        closeModal();
    }
}

// Event listener for form submission
document.getElementById('couponForm').addEventListener('submit', function(event) {
    event.preventDefault(); 
    CreateCoupon();
});

function CreateCoupon() {
    const couponCode = document.getElementById('couponCode').value;
    const minPurchaseAmount = document.getElementById('minPurchaseAmount').value;
    const discountAmount = document.getElementById('discountAmount').value;
    const date = document.getElementById('date').value;
    const expiryDate = document.getElementById('expiryDate').value;

    // Validation
let isValid = true;
let errorMessage = '';

// Coupon Code: at least one special character and one number
if (!/^(?=.*[!@#$%^&*])(?=.*\d).+$/.test(couponCode)) {
    isValid = false;
    errorMessage += 'Coupon Code must contain at least one special character and one number.\n';
}

// MinPurchaseAmount and DiscountAmount: must be non-negative numbers
if (isNaN(minPurchaseAmount) || minPurchaseAmount < 0) {
    isValid = false;
    errorMessage += 'Minimum Purchase Amount must be a non-negative number.\n';
}

if (isNaN(discountAmount) || discountAmount <= 0) {
    isValid = false;
    errorMessage += 'Discount Amount must be a positive number.\n';
}

// Discount Amount must be greater than MinPurchaseAmount
if (minPurchaseAmount <= discountAmount) {
    isValid = false;
    errorMessage += 'Discount Amount must be greater than Minimum Purchase Amount.\n';
}



// Show error message if validation fails
if (!isValid) {
    const errorMessageElement = document.getElementById('errorMessagee');
    errorMessageElement.textContent = errorMessage;
    errorMessageElement.style.display = 'block';
    return;
}


    const data = {
        couponCode,
        minPurchaseAmount,
        discountAmount,
        date,
        expiryDate
    };

    console.log(data);

    fetch('/Add-Coupon', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        const errorMessageElement = document.getElementById('errorMessagee');
        errorMessageElement.textContent = data.message;
        errorMessageElement.style.display = 'block';
        if (data.success) {
            const errorMessageElement = document.getElementById('errorMessage');
        errorMessageElement.textContent = data.message;
        errorMessageElement.style.display = 'block';
            closeModal();
         setTimeout(() => {
            errorMessageElement.style.display = 'none';
            window.location.reload()
         }, 3000);
        }else{

        }
    })
    .catch((error) => {
        console.error('Error:', error);
        const errorMessageElement = document.getElementById('errorMessagee');
        errorMessageElement.textContent = 'An error occurred. Please try again.';
        errorMessageElement.style.display = 'block';
    });
}
  </script>

  <script>
    //delete coupon
    function Delete(id) {
  console.log(id, "id kitteele");

  swal.fire({
    text: "You won't want to delete this!",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#3085d6",
    cancelButtonColor: "#d33",
    confirmButtonText: "Yes, delete it!",
  }).then((result) => {
    if (result.isConfirmed) {
      console.log("fetch working");

      fetch(`/delete-Coupon/${id}`, {
        method: "POST",
      })
        .then((response) => response.json())
        .then((res) => {
          swal.fire({
            text: res.message,
            icon: "success",
            timer: 3000,
            showConfirmButton: false,
          });
          console.log("pakkaa settayi");
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        })
        .catch((error) => {
          swal.fire({
            text: "Something went wrong",
            icon: "error",
            timer: 3000,
            showConfirmButton: false,
          });
          console.error('Error deleting category:', error);
        });
    }
  });
}






// edit time
function OpenModal(button) {

 // Get data attributes from the button
    const CouponId=button.getAttribute('data-id')
    const couponCode = button.getAttribute('data-code');
    const minPurchaseAmount = button.getAttribute('data-minpurchaseamount');
    const discountAmount = button.getAttribute('data-discountamount');
    const date = button.getAttribute('data-date');
    const expiryDate = button.getAttribute('data-expirydate');
    console.log("ithokke oke aahno  id ",CouponId);
    console.log("ithokke oke aahno",minPurchaseAmount);

    // Populate modal fields
    document.getElementById("edit-id").value=CouponId
    document.getElementById('couponCodee').value = couponCode;
    document.getElementById('minPurchaseAmountt').value = minPurchaseAmount;
    document.getElementById('discountAmountt').value = discountAmount;
    document.getElementById('datee').value = date;
    document.getElementById('expiryDatee').value = expiryDate;


    document.getElementById('editCouponModal').style.display = 'block';


}

function StopModal() {
    document.getElementById('editCouponModal').style.display = 'none';
}



function StoreCoupon() {
    document.getElementById('editCouponModal').addEventListener('submit',function(event) {
        event.preventDefault()

   const couponId= document.getElementById("edit-id").value
   const couponCode=  document.getElementById('couponCodee').value
   const  minPurchaseAmount= document.getElementById('minPurchaseAmountt').value
   const discountAmount= document.getElementById('discountAmountt').value
   const date= document.getElementById('datee').value
   const expiryDate =document.getElementById('expiryDatee').value




 // Validation
 let isValid = true;
let errorMessage = '';

// Coupon Code: at least one special character and one number
if (!/^(?=.*[!@#$%^&*])(?=.*\d).+$/.test(couponCode)) {
    isValid = false;
    errorMessage += 'Coupon Code must contain at least one special character and one number.\n';
}

// MinPurchaseAmount and DiscountAmount: must be non-negative numbers
if (isNaN(minPurchaseAmount) || minPurchaseAmount < 0) {
    isValid = false;
    errorMessage += 'Minimum Purchase Amount must be a non-negative number.\n';
}

if (isNaN(discountAmount) || discountAmount <= 0) {
    isValid = false;
    errorMessage += 'Discount Amount must be a positive number.\n';
}

// Discount Amount must be greater than MinPurchaseAmount
if (minPurchaseAmount <= discountAmount) {
    isValid = false;
    errorMessage += 'Discount Amount must be greater than Minimum Purchase Amount.\n';
}



// Show error message if validation fails
if (!isValid) {
    const errorMessageElement = document.getElementById('errorMes');
    errorMessageElement.textContent = errorMessage;
    errorMessageElement.style.display = 'block';
    return;
}

       const data={
        couponId,
        couponCode,
        minPurchaseAmount,
        discountAmount,
        date,
        expiryDate
       }

       fetch('/edit-Coupon',{
        method:'POST',
        headers:{
            'content-type':'Application/json'
        },
       body:JSON.stringify(data)
       })
       .then(response=>response.json())
       .then(response=>{
        const errmess = document.getElementById('errmess');
         if(response.success){
            
          const errorMessageElement = document.getElementById('errorMessage');
        errorMessageElement.textContent = response.message;
        errorMessageElement.style.display = 'block'; 
        StopModal();
        setTimeout(() => {
            errorMessageElement.style.display = 'none'; 
        }, 3000);
        
         
         }

       })

    })
}
  </script>
  
   
</body>
</html>
