<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Management</title>
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- DataTables CSS CDN -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        .success {
            color:red;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
    </style>

    <style>
      
select[name="orderStatus"] {
  padding: 2px 8px; 
  font-size: 14px; 
  border: 1px solid #ccc; 
  border-radius: 4px; 
  background-color: #fff; 
  color: #333; 
  width: 100%; 
}


select[name="orderStatus"] option {
  background-color: #fff; 
  color: #333; 
}


select[name="orderStatus"] option:checked {
  background-color: #f0f0f0; 
  font-weight: bold; 
}

    </style>
</head>
<body>

    <%-include('../admin/adminpartials/Header')-%>
    
    <!-- navbar start  -->
    <div class="content">
        <%-include('../admin/adminpartials/adminNav')-%>
        <!-- navbar start  -->
        <!-- adminSidebar start -->
        <%-include('../admin/adminpartials/adminSidebar')-%>
        <!-- adminSidebar start -->

        <div class="container-fluid">
            <div class="container mt-5">
                <h1 class="mb-4">Order Management</h1>
                 
                <table id="userTable" class="table table-striped table-bordered text-center">
                    <thead class="thead-dark">
                      <tr>
                        <th scope="col">Customer</th>
                        <th scope="col">OrderID</th>
                        <th scope="col">Payment</th>
                        <th scope="col">Quantity</th>
                        <th scope="col">Date</th>
                        <th scope="col">Price</th>
                        <th scope="col">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% ORDER.forEach((order, index) => { %>
                        <tr>
                          <td><%= order.customer.name %></td>
                          <td><%= order.orderID %></td>
                          <td><%= order.paymentMethod %></td>
                          <td><%= order.products.reduce((sum, product) => sum + product.quantity, 0) %></td>
                          <td><%= new Date(order.orderDate).toLocaleDateString('en-IN') %></td>
                          <td><%= order.totalprice %></td>
                          <td>
                            <select name="orderStatus" data-order-id="<%= order.orderID %>">
                              <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                              <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                              <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                              <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                              <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                              <option value="PaymentFailed" <%= order.status === 'PaymentFailed' ? 'selected' : '' %>>PaymentFailed</option>
                            </select>
                          </td>
                        </tr>
                      <% }) %>  
                    </tbody>
                  </table>
            </div>
        </div>

        <!-- Bootstrap JS, Popper.js, and jQuery CDN -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <!-- DataTables JS CDN -->
        <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

        <script src="/js/userajax.js"></script>

        <script>
            $(document).ready(function() {
                $('#userTable').DataTable();
            });
        </script>
    </div>





    <script>
        document.addEventListener('DOMContentLoaded', function() {
  const orderStatusSelects = document.querySelectorAll('select[name="orderStatus"]');
  
  orderStatusSelects.forEach(select => {
    select.addEventListener('change', function() {
      const orderId = this.dataset.orderId;
      const newStatus = this.value;
      
      fetch('/update-order-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ orderId: orderId, status: newStatus })
      })
      .then(response => response.json())
      .then(data => {
        if (   data.success) {
          console.log(data.status);
             if(data.status=='Cancelled'){
              console.log("hiiiiiiii");
              this.disabled = true;
             }else{
              console.log("okeaaahhnu");
              // this.disabled = false;
             }
        } else {
          alert('Failed to update order status');
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
  });
});

    </script>
</body>
</html>
